 # <-- force CSH to use Bourne shell
# BWNFSD daemon

#
#	This is a daemon similar to PCNFSD but also does file locking
#	for those times that LOCKD cannot be found by clients.
#


P=bwnfsd
DEMONPROG=/etc/bin/bwnfsd
SPOOLDIR=/var/spool/bws


PS="/usr/bin/ps -ef"
GREP=/usr/bin/grep

DPD=`dirname ${DEMONPROG} `
DPF=`basename ${DEMONPROG} `
TFA=/tmp/isa${$}
TFB=/tmp/isb${$}


cd /


V=0
substr() {
  while read LINE ; do

    F_GOT=true
    for S in "${@}" ; do

      echo $LINE | fgrep $S > /dev/null
      if [ $? -ne $V ] ; then

        F_GOT=false
        break

      fi

    done

    if [ $F_GOT = true ] ; then

      echo $LINE

    fi

  done
}


# are we already running

V=0
${PS} | substr root '?' $DPF > $TFB

V=1
substr < $TFB grep rc > $TFA



case "${1}" in

'start' )
  if [ ! -s $TFA -a -x "${DEMONPROG}" ] ; then (

# remember to give time enough for 100005 RPC call server program

	sleep 30
	if [ ! -d ${SPOOLDIR} ] ; then

	  mkdir ${SPOOLDIR} 
	  chmod 777 ${SPOOLDIR}

	fi
        PATH=${DPD}:${PATH} $DPF ${SPOOLDIR} &

  ) & fi
  ;;

'stop' )
  if [ -s $TFA ] ; then

    while read USER PID J ; do 

      if [ "${USER}" = root ] ; then

        /usr/bin/kill ${PID}
        break

      fi

    done < $TFA

  fi
  ;;

* )
  echo "${P}: USAGE> /etc/init.d/${P} {start|stop}"
  ;;

esac

rm -f $TFA $TFB


